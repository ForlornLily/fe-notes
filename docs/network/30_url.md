# 输入 URL 到页面渲染完成的过程

## 概要

参考：

- [从 URL 输入到页面展现到底发生什么？](https://github.com/ljianshu/Blog/issues/24)

1.  首先做 DNS 查询，如果这一步做了智能 DNS 解析的话，会提供访问速度最快的 IP
    地址回来
    DNS 缓存：浏览器缓存、路由器缓存、DNS 缓存
2.  接下来是 TCP 握手，应用层会下发数据给传输层，这里 TCP
    协议会指明两端的端口号，然后下发给网络层。网络层中的 IP 协议会确定 IP
    地址，并且指示了数据传输中如何跳转路由器（ARP 协议）。  
    然后包会再被封装到数据链路层的数据帧结构中，最后就是物理层面的传输了

3.  TCP 握手结束后会进行 TLS 握手，然后就开始正式的传输数据

4.  数据在进入服务端之前，可能还会先经过负责负载均衡的服务器，它的作用就是将请求合理的分发到多台服务器上，这时假设服务端会响应一个
    HTML 文件

5.  首先浏览器会判断状态码是什么，如果是 200 那就继续解析，如果 400 或 500
    的话就会报错，如果 300
    的话会进行重定向，这里会有个重定向计数器，避免过多次的重定向，超过次数也会报错

6.  浏览器开始解析文件，如果是 gzip
    格式的话会先解压一下，然后通过文件的编码格式知道该如何去解码文件

7.  文件解码成功后会正式开始渲染流程，先会根据 HTML 构建 DOM 树，有 CSS
    的话会去构建 CSSOM 树。如果遇到 script 标签的话，会判断是否存在 async 或者
    defer ，前者会并行进行下载并执行 JS，后者会先下载文件，然后等待 HTML
    解析完成后顺序执行，如果以上都没有，就会阻塞住渲染流程直到 JS
    执行完毕。遇到文件下载的会去下载文件，这里如果使用 HTTP 2.0
    协议的话会极大的提高多图的下载效率。

8.  初始的 HTML 被完全加载和解析后会触发[DOMContentLoaded](../js/002_script.md) 事件

9.  CSSOM 树和 DOM 树构建完成后会开始生成 Render
    树，这一步就是确定页面元素的布局、样式等等诸多方面的东西

10. 在生成 Render 树的过程中，浏览器就开始调用 GPU
    绘制，合成图层，将内容显示在屏幕上了

## href

[参考](https://juejin.im/post/5b88ddca6fb9a019c7717096)

- css 加载不会阻塞 DOM 树的解析
- css 加载会阻塞 DOM 树的渲染
- css 加载会阻塞后面 js 语句的执行

原因是 DOM 树和 CSSOM 树的解析是并行执行的，见[浏览器加载过程](../js/033_best_practice.md)，但 Rentder Tree 是依赖于 DOM Tree 和 CSSOM Tree 的，所以必须等待到 CSSOM Tree 构建完成，也就是 CSS 资源加载完成(或者 CSS 资源加载失败)后，才能开始渲染  
同样 JS 会可能会操作 DOM 和 CSS，所以等 CSS 加载玩

### css 优化方案

- 使用[CDN](./29_cdn.md)
- 对 css 进行压缩(比如 webpack,，gzip)
- 合理的使用缓存(设置 cache-control,expires,以及 E-tag 都是不错的，不过要注意缓存而带来的影响：版本更新时新旧资源的处理)
- 减少 http 请求数，将多个 css 文件合并，或者是干脆直接写成内联样式(内联样式的一个缺点就是不能缓存)
